worker_processes 1;

pid  /run/nginx.pid;

error_log  /var/log/nginx/nginx_error.log  warn;

#error_log  /dev/stdout  info;

events { worker_connections 1024; }

http {

  include /etc/nginx/sites-enabled/*.conf;
  server_names_hash_bucket_size 64;


  upstream neocompiler {
    server 172.17.0.1:8000;
    server neocompiler-eco.neoresearch.io backup;
    #server neoresearch.io/neocompiler-eco;
  }

#  upstream node1 {
#    server http://172.19.0.3:30333;
#  }
#  upstream node2 {
#    server http://172.19.0.3:30334;
#  }
#  upstream node3 {
#    server http://172.19.0.3:30335;
#  }
#  upstream node4 {
#    server http://172.19.0.3:30336;
#  }

  upstream neoscan {
    server 172.17.0.1:4000;
 }

  server {
   listen         80;
     return 301 https://$host$request_uri;
   }

  #neocompiler.io

#  server {
#    listen 30333 ssl http2;
#    server_name neocompiler.io;
#    proxy_pass http://172.19.0.3:30333;
#  }



  #rest
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   server_name rest.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;
   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://neocompiler.io:8080/;
   }
 } #rest

  #compilers
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   server_name compilers.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;
   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://neocompiler.io:10000/;
   }
 } #compilers


  #ecoservices
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   server_name ecoservices.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;
   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://neocompiler.io:9000/;
   }
 } #ecoservices
  #rpc python (eco subdomain for now)

#  server {
#   listen 443 ssl http2;
#   listen [::]:443 ssl http2;
#
#   server_name eco.neocompiler.io;
#    ssl on;
#    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
#    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

#   if ($scheme != "https") {
#        return 301 https://$host$request_uri;
#   }

#   location / {
#    proxy_set_header  X-Real-IP  $remote_addr;
#    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
#    proxy_set_header Host $http_host;
#    proxy_set_header X-Forwarded-Proto https;
#    proxy_redirect off;
#    proxy_pass http://neocompiler.io:10332/;
#   }
# } #rpc python
  #node1
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   add_header Strict-Transport-Security "max-age=31536000" always;

   server_name node1.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://neocompiler.io:30333/;
   }
 } #node1

  #node2
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   add_header Strict-Transport-Security "max-age=31536000" always;

   server_name node2.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
   ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://neocompiler.io:30337/;
   }
 } #node2

  #node3
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   add_header Strict-Transport-Security "max-age=31536000" always;

   server_name node3.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
   proxy_redirect off;
    proxy_pass http://neocompiler.io:30338/;
   }
 } #node3

  #node4
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   add_header Strict-Transport-Security "max-age=31536000" always;

   server_name node4.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://neocompiler.io:9000/;
   }
 } #node4

  #main server
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   # add Strict-Transport-Security to prevent man in the middle attacks
  add_header Strict-Transport-Security "max-age=31536000" always;

   server_name eco.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

    return 301 https://neocompiler.io$request_uri;  
  }

  #main server Eco
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   # add Strict-Transport-Security to prevent man in the middle attacks
   add_header Strict-Transport-Security "max-age=31536000" always;

   server_name neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

 location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_redirect off;
    proxy_pass http://neocompiler;
 }  
 } #neocompiler.io


  #neoscan
  server {
   listen 443 ssl http2 ;
   listen [::]:443 ssl http2;
   server_name neoscan.neocompiler.io;

    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

    if ($scheme != "https") {
        return 301 https://$host$request_uri;
    }

#location /socket {
# proxy_http_version 1.1;
# proxy_set_header Upgrade $http_upgrade;
# proxy_set_header Connection "upgrade";
# proxy_read_timeout 86400;
# proxy_pass http://neoscan;
#}

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_redirect off;
    proxy_pass http://neoscan;
   }

 } #neoscan


}

#daemon off;
