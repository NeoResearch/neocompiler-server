worker_processes 1;

pid  /run/nginx.pid;

error_log  /var/log/nginx/nginx_error.log  warn;

#error_log  /dev/stdout  info;

events { worker_connections 1024; }

#==================================================================
#==================================================================
#==================== BEGIN HTTP ==================================
http {

  include /etc/nginx/sites-enabled/*.conf;
  server_names_hash_bucket_size 64;

  upstream neocompiler {
    server neocompiler-eco.neoresearch.io;
  }

  upstream neoscan {
    server 172.17.0.1:4000;
  }

  server {
     listen         80;
     return 301 https://$host$request_uri;
  }
  #==================================================================
  #==================================================================
  #==================== STARTING SSL CERTIFICATES ===================

  #==================================================================
  #======================= MAIN ECO SERVER ==========================
  server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # add Strict-Transport-Security to prevent man in the middle attacks
    add_header Strict-Transport-Security "max-age=31536000" always;

    server_name eco.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

    return 301 https://neocompiler.io$request_uri;  
  }
  #======================= MAIN ECO SERVER ==========================
  #==================================================================

  #==================================================================
  #======================= MAIN SERVER ==============================
   server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # add Strict-Transport-Security to prevent man in the middle attacks
    add_header Strict-Transport-Security "max-age=31536000" always;

    server_name neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

    #Is this needed Igor? TODO I read that it makes slower to double check
    if ($scheme != "https") {
         return 301 https://$host$request_uri;
    }
    location / {
     #proxy_pass http://neocompiler-eco.neoresearch.io;
     #proxy_intercept_errors on;
     # allow GitHub to pass caching headers instead of using our own
     #expires off;

     proxy_set_header  X-Real-IP  $remote_addr;
     proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
     proxy_set_header Host $http_host;
     proxy_set_header X-Forwarded-Proto https;
     proxy_http_version 1.1;
     proxy_set_header Upgrade $http_upgrade;
     proxy_set_header Connection "upgrade";
     proxy_redirect off;
     proxy_pass http://neocompiler;
   }  
  } #neocompiler
  #======================= MAIN ECO SERVER II =======================
  #==================================================================

  #==================================================================
  #======================= NEOSCAN ==================================
  server {
   listen 443 ssl http2 ;
   listen [::]:443 ssl http2;
   server_name neoscan.neocompiler.io;

    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

    if ($scheme != "https") {
        return 301 https://$host$request_uri;
    }
   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_redirect off;
    proxy_pass http://neoscan;
   }
  } #neoscan
  #======================= NEOSCAN ==================================
  #==================================================================

  #==================================================================
  #=========================== COMPILERS ============================
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   server_name compilers.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;
   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://neocompiler.io:10000/;
   }
  }
  #=========================== COMPILERS ============================
  #==================================================================

  #==================================================================
  #=========================== COMPILERS2 ===========================
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   server_name compilers2.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;
   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://178.128.203.47:10000/;
   }
 } 
  #=========================== COMPILERS2 ===========================
  #==================================================================

  #==================================================================
  #=========================== TESTNET RPC ===========================
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   add_header Strict-Transport-Security "max-age=31536000" always;

   server_name testnetrpcallplugins.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;
   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://178.128.203.47:20332/;
   }
 } 
  #=========================== TESTNET RPC ===========================
  #==================================================================

  #==================================================================
  #======================= ECOSERVICES ==============================
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   server_name ecoservices.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;
   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://neocompiler.io:9000/;
   }
  }
  #======================= ECOSERVICES ==============================
  #==================================================================

  #==================================================================
  #======================= NODE1 ====================================
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   add_header Strict-Transport-Security "max-age=31536000" always;

   server_name node1.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://neocompiler.io:30333/;
   }
  }
  #======================= NODE1 ====================================
  #==================================================================

  #==================================================================
  #======================= NODE2 ====================================
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   add_header Strict-Transport-Security "max-age=31536000" always;

   server_name node2.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
   ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://neocompiler.io:30334/;
   }
  }
  #======================= NODE2 ====================================
  #==================================================================

  #==================================================================
  #======================= NODE3 ====================================
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   add_header Strict-Transport-Security "max-age=31536000" always;

   server_name node3.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
   proxy_redirect off;
    proxy_pass http://neocompiler.io:30337/;
   }
  }
  #======================= NODE3 ====================================
  #==================================================================

  #==================================================================
  #======================= NODE4 ====================================
  server {
   listen 443 ssl http2;
   listen [::]:443 ssl http2;

   add_header Strict-Transport-Security "max-age=31536000" always;

   server_name node4.neocompiler.io;
    ssl on;
    ssl_certificate /etc/letsencrypt/live/neocompiler.io-0002/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/neocompiler.io-0002/privkey.pem;

   if ($scheme != "https") {
        return 301 https://$host$request_uri;
   }

   location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_redirect off;
    proxy_pass http://neocompiler.io:9000/;
   }
  } 
  #======================= NODE4 ====================================
  #==================================================================
}
#==================== END HTTP ====================================
#==================================================================
#==================================================================
